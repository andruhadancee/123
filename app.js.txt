// Инициализация Telegram Web App
const tg = window.Telegram.WebApp;
tg.expand();
tg.enableClosingConfirmation();

// Глобальные переменные
let currentPosition = null;
let currentFilters = {
    rating: null,
    position: null
};
let filteredProfiles = [];
let currentProfileIndex = 0;

// Показ экрана
function showScreen(screenId) {
    document.querySelectorAll('.screen').forEach(screen => {
        screen.classList.remove('active');
    });
    document.getElementById(screenId).classList.add('active');
    
    // Обновляем данные при показе определенных экранов
    if (screenId === 'myProfile') {
        loadProfile();
    }
}

// Выбор позиции
function selectPosition(pos) {
    currentPosition = pos;
    document.querySelectorAll('.pos-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    document.querySelectorAll('.pos-btn')[pos-1].classList.add('active');
    document.getElementById('position').value = pos;
}

// Предпросмотр анкеты
function previewApplication() {
    const name = document.getElementById('name').value;
    const tgUsername = document.getElementById('tgUsername').value;
    const mmr = document.getElementById('mmr').value;
    const position = document.getElementById('position').value;
    const about = document.getElementById('aboutText').value;
    
    if (!name || !tgUsername || !mmr || !position) {
        alert('Заполните все обязательные поля!');
        return;
    }
    
    const previewContent = `
        <h3>${name}</h3>
        <p><strong>TG:</strong> @${tgUsername}</p>
        <p><strong>MMR:</strong> ${mmr}</p>
        <p><strong>Позиция:</strong> ${position}</p>
        <p><strong>О себе:</strong> ${about || 'Не указано'}</p>
    `;
    
    document.getElementById('previewContent').innerHTML = previewContent;
    showScreen('preview');
}

// Сохранение анкеты
function saveApplication() {
    const application = {
        name: document.getElementById('name').value,
        tgUsername: document.getElementById('tgUsername').value,
        mmr: parseInt(document.getElementById('mmr').value),
        position: parseInt(document.getElementById('position').value),
        about: document.getElementById('aboutText').value,
        timestamp: new Date().toISOString()
    };
    
    // Сохраняем в localStorage (в реальном приложении - отправляем на сервер)
    localStorage.setItem('userApplication', JSON.stringify(application));
    
    // Показываем уведомление
    if (tg.showPopup) {
        tg.showPopup({
            title: 'Успешно!',
            message: 'Анкета сохранена',
            buttons: [{ type: 'ok' }]
        });
    }
    
    showScreen('myProfile');
}

// Загрузка профиля
function loadProfile() {
    const application = JSON.parse(localStorage.getItem('userApplication'));
    const profileContent = document.getElementById('profileContent');
    
    if (!application) {
        profileContent.innerHTML = '<p>Анкета не заполнена</p>';
        return;
    }
    
    profileContent.innerHTML = `
        <h3>${application.name}</h3>
        <p><strong>TG:</strong> @${application.tgUsername}</p>
        <p><strong>MMR:</strong> ${application.mmr}</p>
        <p><strong>Позиция:</strong> ${application.position}</p>
        <p><strong>О себе:</strong> ${application.about || 'Не указано'}</p>
    `;
}

// Редактирование анкеты
function editApplication() {
    const application = JSON.parse(localStorage.getItem('userApplication'));
    
    if (application) {
        document.getElementById('name').value = application.name;
        document.getElementById('tgUsername').value = application.tgUsername;
        document.getElementById('mmr').value = application.mmr;
        document.getElementById('aboutText').value = application.about || '';
        selectPosition(application.position);
    }
    
    showScreen('findTeam');
}

// Удаление анкеты
function deleteApplication() {
    if (confirm('Вы уверены, что хотите удалить анкету?')) {
        localStorage.removeItem('userApplication');
        loadProfile();
    }
}

// Установка фильтров
function setRatingFilter(range) {
    currentFilters.rating = range;
}

function setPositionFilter(pos) {
    currentFilters.position = pos === 0 ? null : pos;
}

// Поиск анкет
function startSearch() {
    // В реальном приложении здесь будет запрос к серверу
    // Сейчас используем mock данные
    filteredProfiles = getMockProfiles().filter(profile => {
        let matches = true;
        
        // Фильтр по рейтингу
        if (currentFilters.rating) {
            const [min, max] = currentFilters.rating.split('-').map(Number);
            matches = matches && profile.mmr >= min && profile.mmr <= max;
        }
        
        // Фильтр по позиции
        if (currentFilters.position) {
            matches = matches && profile.position === currentFilters.position;
        }
        
        return matches;
    });
    
    if (filteredProfiles.length === 0) {
        alert('Анкет не найдено по выбранным фильтрам');
        return;
    }
    
    currentProfileIndex = 0;
    showProfile();
    showScreen('viewProfiles');
}

// Показ анкеты
function showProfile() {
    if (filteredProfiles.length === 0) return;
    
    const profile = filteredProfiles[currentProfileIndex];
    document.getElementById('currentProfile').innerHTML = `
        <h3>${profile.name}</h3>
        <p><strong>TG:</strong> @${profile.tgUsername}</p>
        <p><strong>MMR:</strong> ${profile.mmr}</p>
        <p><strong>Позиция:</strong> ${profile.position}</p>
        <p><strong>О себе:</strong> ${profile.about}</p>
        <p><small>Анкета #${currentProfileIndex + 1} из ${filteredProfiles.length}</small></p>
    `;
}

// Навигация по анкетам
function nextProfile() {
    if (currentProfileIndex < filteredProfiles.length - 1) {
        currentProfileIndex++;
        showProfile();
    }
}

function prevProfile() {
    if (currentProfileIndex > 0) {
        currentProfileIndex--;
        showProfile();
    }
}

// Mock данные для демонстрации
function getMockProfiles() {
    return [
        {
            name: "Алексей",
            tgUsername: "alexey123",
            mmr: 4500,
            position: 1,
            about: "Ищу серьезную команду для участия в турнирах"
        },
        {
            name: "Дмитрий",
            tgUsername: "dmitry_pro",
            mmr: 3200,
            position: 2,
            about: "Опытный игрок, хорошая коммуникация"
        },
        {
            name: "Сергей",
            tgUsername: "sergey_mid",
            mmr: 7800,
            position: 3,
            about: "Люблю контролировать темп игры"
        }
    ];
}

// Инициализация при загрузке
document.addEventListener('DOMContentLoaded', function() {
    loadProfile();
});